"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const file_utils_1 = require("../../file-utils");
const json_diff_1 = require("../../../utils/json-diff");
exports.getTouchedProjectsInNxJson = (touchedFiles, workspaceJson, nxJson) => {
    const nxJsonChange = touchedFiles.find(change => change.file === 'nx.json');
    if (!nxJsonChange) {
        return [];
    }
    const changes = nxJsonChange.getChanges();
    if (changes.some(change => {
        if (json_diff_1.isJsonChange(change)) {
            return change.path[0] !== 'projects';
        }
        if (file_utils_1.isWholeFileChange(change)) {
            return true;
        }
        return false;
    })) {
        return Object.keys(nxJson.projects);
    }
    const touched = [];
    for (let i = 0; i < changes.length; i++) {
        const change = changes[i];
        if (!json_diff_1.isJsonChange(change) || change.path[0] !== 'projects') {
            continue;
        }
        if (nxJson.projects[change.path[1]]) {
            touched.push(change.path[1]);
        }
        else {
            // The project was deleted so affect all projects
            touched.push(...Object.keys(nxJson.projects));
            // Break out of the loop after all projects have been added.
            break;
        }
    }
    return touched;
};
