"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const file_utils_1 = require("../../file-utils");
const json_diff_1 = require("../../../utils/json-diff");
exports.getTouchedNpmPackages = (touchedFiles, workspaceJson, nxJson, packageJson) => {
    const packageJsonChange = touchedFiles.find(f => f.file === 'package.json');
    if (!packageJsonChange)
        return [];
    let touched = [];
    const changes = packageJsonChange.getChanges();
    for (const c of changes) {
        if (json_diff_1.isJsonChange(c) &&
            (c.path[0] === 'dependencies' || c.path[0] === 'devDependencies')) {
            // A package was deleted so mark all packages as touched
            // so projects with any package dependency will be affected.
            if (c.type === json_diff_1.DiffType.Deleted) {
                touched = Object.keys(Object.assign(Object.assign({}, (packageJson.dependencies || {})), (packageJson.devDependencies || {})));
                break;
            }
            else {
                touched.push(c.path[1]);
            }
        }
        else if (file_utils_1.isWholeFileChange(c)) {
            touched = Object.keys(workspaceJson.projects);
            break;
        }
    }
    return touched;
};
